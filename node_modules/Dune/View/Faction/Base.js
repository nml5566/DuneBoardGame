module.exports = BaseFactionView;

var Loader = require("Dune/Loader");
var canvasContainer = require("Dune/CanvasContainer");
var eventChain = require("Dune/EventChain");

var ViewDecorator = require("../Base");

var treacheryDeckView = require("../Deck/Treachery.js");
var bonusDeckView = require("../Deck/Bonus.js");
var PlayerScreen = require("../PlayerScreen");
var mapView = require("Dune/View/Map");

var TraitorSelect = require("../TraitorSelect.js");

function BaseFactionView(obj, args) {

  ViewDecorator(obj, { "view": undefined });

  if (! args["private"])
    args["private"] = { };

  var faction = args.faction,
      images = args.images;

  var traitorSelect = args.traitorSelect || new TraitorSelect();

  //TODO figure out an elegant way to squash this public variable
  obj.faction = faction;

  var playerScreen = new PlayerScreen(images);
  args["private"].playerScreen = playerScreen;

  var factionEmblemImg, 
      factionShieldImg;

  var dealtCard;

  obj.loadImages = function() {

    var loader = new Loader();

    var factionEmblemImgUrl = obj.imagePath + "emblems/" + images.emblem;
    factionEmblemImg = loader.loadImage(factionEmblemImgUrl)

    var troopIconImgUrl = "/img/icons/troops/" + images.troop;
    images.troop = loader.loadImage(troopIconImgUrl);
    images.troop.faction = faction;

    for (var i = 0; i < images.leaders.length; i++) {
      var leaderImgUrl = images.leaderPath + images.leaders[i];
      images.leaders[i] = loader.loadImage(leaderImgUrl);
    }


    loader.onload = function() {
      obj.drawPlayerSeat();
    };

  }

  obj.startSetupTurn = function() 
  {
    obj.startTurn();
    obj.setupEventChain();
  }

  obj.startTurn = function() 
  {
    playerScreen.draw();
    //DEBUG
    obj.promptUserStartTurn();
  }


  obj.setupEventChain = function() {
    eventChain.add([
      function() { 
      	obj.promptUserSelectTraitor() },
      function() { playerScreen.addTraitorCard(obj.dealtCard()) },
      function() { obj.drawTreacheryCard() },
      function() { playerScreen.addTreacheryCard(obj.dealtCard()) },
      function() { obj.shipInitialTroops() }
    ]);
  }

  obj.promptUserStartTurn = function() {

    canvas = canvasContainer.layer("notification");
    context = canvas.getContext("2d");

    //canvasContainer.moveLayerToTop(canvas);

    canvas.addEventListener("mousedown", function(e) {
      dismissUserPromptNotification();
    });

    var loader = new Loader();

    var factionShieldName = faction.constructor.name.toLowerCase() 
      + "-shield.png"
    var factionShieldUrl = obj.imagePath + factionShieldName;
    factionShieldImg = loader.loadImage(factionShieldUrl);
    factionShieldImg.speed = 0.01;

    loader.onload = drawUserPromptNotification;
  }

  function dismissUserPromptNotification() {
    canvasContainer.deleteLayer(canvas);

    eventChain.next();
  }

  function drawUserPromptNotification() {

    factionShieldImg.xPos = 0;
    factionShieldImg.yPos = 0;

    factionShieldImg.yPos = -factionShieldImg.height;

    moveImageToPoint(factionShieldImg, [0,250]);
  }

  function moveImageToPoint(image, point) {
    var finalX = point[0],
	finalY = point[1];

    image.xStep = (finalX - image.xPos) * image.speed;
    image.yStep = (finalY - image.yPos) * image.speed;

    image.movement = setInterval(function () {
      animateImageMovement(image, [finalX, finalY]);
    }, 10);

  }

  function animateImageMovement(image, point) {
    dimScreen(image);

    var x = point[0];
    var y = point[1];

    image.xPos += image.xStep;
    image.yPos += image.yStep;

    var shieldScaleWidth = 768;
    var shieldScaleHeight = 352;

    context.drawImage(image, 
      image.xPos, image.yPos,
      shieldScaleWidth, shieldScaleHeight
    );

    if (image.yPos + image.yStep >= y) {
      clearInterval(image.movement);
      delete image.movement;
      delete image.xStep;
      delete image.yStep;

      dimScreen(image);

      image.xPos = x
      image.yPos = y

      context.drawImage(image, 
	image.xPos, image.yPos,
	shieldScaleWidth, shieldScaleHeight
      );

      if (image.onhalt) {
	  image.onhalt();
	  image.onhalt = undefined;
      }

    }
  }

  function dimScreen(image) {

    context.clearRect(0, 0, canvas.width, canvas.height);
    context.fillStyle = "rgba(20, 20, 20, 0.6)";
    context.fillRect (0,0,canvas.width,canvas.height);
  }

  obj.getLeaders = function() {
    return faction.getLeaders();
  }

  obj.promptUserSelectTraitor = function() { 
    traitorSelect.promptUser(obj) 
  };

  obj.drawPlayerSeat = function() {

    var canvas = canvasContainer.layer('playerseat');
    var context = canvas.getContext("2d");

    var circle = mapView.circle;
    circle.angle = mapView.convertSectorNumberToMapAngle(faction.seat);

    var iconOffset = factionEmblemImg.width/2;

    var coordinates = 
      mapView.calculateSectorEdgeFromMapAngle([iconOffset, iconOffset]);

    var x = coordinates[0] - iconOffset;
    var y = coordinates[1] - iconOffset;

    context.drawImage(factionEmblemImg, x, y);
  }


  obj.drawTreacheryCard = function()
  {
    var card = treacheryDeckView.dealCard();
    obj.takeCard(card);
  }

  obj.takeCard = function(cardImage) { dealtCard = cardImage }
  obj.dealtCard = function() { return dealtCard }

}

var Loader = require("./Loader");
var canvasContainer = require("./CanvasContainer");

var gameView = require("./View/Game");
var StartMenuView = require("./View/StartMenu");
var FactionSelectView = require("./View/FactionSelect");
var mapView = require("./View/Map");

module.exports = new GameController();

function GameController() {

  var factionViews = {};
  var turnOrder;

  this.startGame = function() 
  {
    gameView.game.start();
    turnOrder = gameView.game.getTurnOrder();

    hideFactionSelectView();
    initViews();
    this.startPlayerTurn();
  }

  this.startPlayerTurn = function() { this.startPlayerSetupTurn() }

  function hideFactionSelectView()
  {
    var factionSelectView = new FactionSelectView();
    factionSelectView.hide();
  }

  function initViews() 
  {
    initFactionViews();
    initMapView();
  }

  function initFactionViews() 
  {
    for (var factionName in gameView.players) {
      var FactionView = getFactionViewConstructor(factionName);
      var factionView = new FactionView();
      factionView.loadImages();
      factionViews[factionName] = factionView;
    }
  }

  function initMapView() {
    mapView.show();
    mapView.loadImages();
  }

  function getFactionViewConstructor(factionName) {
    switch(factionName) {
      case "Atreides":
      	return require("./View/Faction/Atreides");
      case "Harkonnen":
      	return require("./View/Faction/Harkonnen");
      case "BeneGesserit":
      	return require("./View/Faction/BeneGesserit");
      case "Fremen":
      	return require("./View/Faction/Fremen");
      case "Guild":
      	return require("./View/Faction/Guild");
      case "Emperor":
      	return require("./View/Faction/Emperor");
      default:
      	throw new Error("Invalid faction view: "+factionName);
    }
  }


  this.setFactions = function (factionsArray) {
    for (var i = 0; i < factionsArray.length; i++) {
      var factionName = factionsArray[i];
      var player = gameView.game.selectPlayer(factionName);
      gameView.players[factionName] = player;
    }
  }


  this.startPlayerSetupTurn = function() {
    var nextFaction = turnOrder.shift();

    if (! nextFaction) {
      turnOrder = gameView.game.getTurnOrder();
      this.startPlayerTurn = function() { this.startPlayerRegularTurn() }
      return;
    }

    var factionView = factionViews[nextFaction.constructor.name];

    factionView.startSetupTurn();
  }  

  this.startPlayerRegularTurn = function() {
    console.log('start regular turn');
    var nextFaction = turnOrder.shift();

    if (! nextFaction) {
      console.log('TODO add round management');
      return;
    }

    var factionView = factionViews[nextFaction.constructor.name];
    factionView.startTurn();
  }

}
